#!/bin/bash

# Function to check if a line exists in a file
line_exists() {
    grep -qF "$1" "$2"
}

# Function to delete a line from a file
delete_line() {
    sudo sed -i "/$1/d" "$2" || { echo "‚ùå Failed to delete line containing '$1'! Exiting..."; exit 1; }
}

# Step 1: Enable gRPC and REST
echo "üöÄ Enabling gRPC and REST..."
sleep 1
cd "$HOME/ceremonyclient/node" || { echo "‚ùå Failed to change directory to ~/ceremonyclient/node! Exiting..."; exit 1; }

# Delete existing lines for listenGrpcMultiaddr and listenRESTMultiaddr
delete_line "listenGrpcMultiaddr:" .config/config.yml
delete_line "listenRESTMultiaddr:" .config/config.yml

# Add listenGrpcMultiaddr: "/ip4/127.0.0.1/tcp/8337"
echo "listenGrpcMultiaddr: \"/ip4/127.0.0.1/tcp/8337\"" | sudo tee -a .config/config.yml > /dev/null || { echo "‚ùå Failed to enable gRPC! Exiting..."; exit 1; }

# Add listenRESTMultiaddr: "/ip4/127.0.0.1/tcp/8338"
echo "listenRESTMultiaddr: \"/ip4/127.0.0.1/tcp/8338\"" | sudo tee -a .config/config.yml > /dev/null || { echo "‚ùå Failed to enable REST! Exiting..."; exit 1; }

sleep 1

# Step 2: Enable Stats Collection
echo "üìä Enabling Stats Collection..."
if ! line_exists "  statsMultiaddr: \"/dns/stats.quilibrium.com/tcp/443\"" .config/config.yml; then
    sudo sed -i '/^ *engine:/a\  statsMultiaddr: "/dns/stats.quilibrium.com/tcp/443"' .config/config.yml || { echo "‚ùå Failed to enable Stats Collection! Exiting..."; exit 1; }
else
    echo "‚úÖ Stats Collection already enabled."
fi

sleep 1

# Check if all lines were added successfully and are correct
if line_exists "listenGrpcMultiaddr: \"/ip4/127.0.0.1/tcp/8337\"" .config/config.yml && line_exists "listenRESTMultiaddr: \"/ip4/127.0.0.1/tcp/8338\"" .config/config.yml && line_exists "  statsMultiaddr: \"/dns/stats.quilibrium.com/tcp/443\"" .config/config.yml; then
    echo "‚ú® Success: The script successfully edited your config.yml file."
else
    echo "‚ùå ERROR: The script failed to correctly edit your config.yml file or there are typos."
    echo "You may want to follow the online guide to do it manually."
    exit 1
fi

echo "‚úÖ gRPC and REST calls setup was successful."
